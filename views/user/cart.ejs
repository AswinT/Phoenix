<%- include("../partials/user/header") %>

<!-- Cart Styles -->
<link rel="stylesheet" href="/styles/user/cart.css" />

<!-- Cart Page -->
<section class="cart-page-section">
  <div class="container">
    <!-- Breadcrumb -->
    <nav class="cart-breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/shopPage">Shop</a></li>
        <li class="breadcrumb-item active">Cart</li>
      </ol>
    </nav>

    <!-- Cart Header -->
    <div class="cart-header">
      <div class="cart-header-content">
        <div class="cart-icon">
          <i class="ri-shopping-cart-line"></i>
        </div>
        <h1 class="cart-title">Your Cart</h1>
        <p class="cart-subtitle">Review and modify your selected products</p>
      </div>
    </div>

    <!-- Empty Cart State (Full Width) -->
    <% if (cartItems.length === 0) { %>
    <div class="row">
      <div class="col-12">
        <div class="empty-cart-container">
          <div class="empty-cart-card">
            <div class="empty-cart-icon">
              <i class="ri-shopping-cart-line"></i>
            </div>
            <h3 class="empty-cart-title">Your cart is empty</h3>
            <p class="empty-cart-text">Looks like you haven't found your perfect headphones yet</p>
            <a href="/shopPage" class="btn-continue-shopping">
              <i class="ri-headphone-line"></i>
              Continue Shopping
            </a>
          </div>
        </div>
      </div>
    </div>
    <% } else { %>

    <!-- Cart with Items -->
    <div class="row g-4">
      <!-- Cart Items Column -->
      <div class="col-lg-8">
        <!-- Cart Items List -->
        <div class="cart-items-container">
          <div class="cart-items-header">
            <h2 class="items-count">Items (<%= cartItems.reduce((sum, item) => sum + item.quantity, 0) %>)</h2>
            <button class="btn-clear-cart" id="clearCartBtn">
              <i class="ri-delete-bin-line"></i>
              Clear Cart
            </button>
          </div>

          <div class="cart-items-list">
            <% cartItems.forEach(item => { %>
              <div class="cart-item floating-card" data-product-id="<%= item.product._id %>">
                <div class="cart-item-content">
                  <!-- Product Image -->
                  <div class="product-image-section">
                    <div class="product-image-wrapper">
                      <img src="<%= item.product.mainImage || '/api/placeholder/150/200' %>" alt="<%= item.product.model %>" class="product-image" />
                      <% if (item.product.activeOffer && item.product.discountPercentage > 0) { %>
                        <span class="discount-badge">
                          <%= Math.round(item.product.discountPercentage) %>% OFF
                        </span>
                      <% } %>
                    </div>
                  </div>

                  <!-- Product Details -->
                  <div class="product-details-section">
                    <div class="product-info">
                      <h3 class="product-title"><%= item.product.model %></h3>
                      <div class="product-meta">
                        <span class="product-brand">
                          <i class="ri-headphone-line"></i>
                          <%= item.product.brand %>
                        </span>
                        <% if (item.product.connectivity) { %>
                          <span class="product-connectivity">
                            <i class="ri-wireless-charging-line"></i>
                            <%= item.product.connectivity %>
                          </span>
                        <% } %>
                      </div>
                      
                      <% if (item.product.activeOffer) { %>
                        <div class="offer-info">
                          <i class="ri-gift-line"></i>
                          <%= item.product.activeOffer.title %>
                        </div>
                      <% } %>

                      <!-- Stock Status -->
                      <div class="stock-status stock-<%= item.product.stock > 10 ? 'in-stock' : item.product.stock > 0 ? 'low-stock' : 'out-of-stock' %>">
                        <i class="<%= item.product.stock > 10 ? 'ri-checkbox-circle-line' : item.product.stock > 0 ? 'ri-error-warning-line' : 'ri-close-circle-line' %>"></i>
                        <%= item.product.stock > 10 ? `In Stock (${item.product.stock} available)` : item.product.stock > 0 ? `Low Stock (${item.product.stock} left)` : 'Out of Stock' %>
                      </div>
                    </div>
                  </div>

                  <!-- Quantity & Price Section -->
                  <div class="quantity-price-section">
                    <!-- Quantity Controls -->
                    <div class="quantity-section">
                      <label class="quantity-label">Quantity:</label>
                      <div class="quantity-controls">
                        <button class="quantity-btn quantity-minus">
                          <i class="ri-subtract-line"></i>
                        </button>
                        <input type="number" class="quantity-input" value="<%= item.quantity %>" min="1" max="<%= Math.min(5, item.product.stock) %>" readonly>
                        <button class="quantity-btn quantity-plus">
                          <i class="ri-add-line"></i>
                        </button>
                      </div>
                    </div>

                    <!-- Price & Actions -->
                    <div class="price-actions-section">
                      <div class="price-display">
                        <!-- Unit Price Display -->
                        <div class="unit-price-section">
                          <span class="price-label">Price per item:</span>
                          <div class="unit-prices">
                            <% if (item.product.discountPercentage > 0) { %>
                              <span class="original-price">₹<%= item.product.regularPrice.toFixed(2) %></span>
                              <span class="discounted-price">₹<%= item.product.finalPrice.toFixed(2) %></span>
                              <span class="savings-amount">Save ₹<%= (item.product.regularPrice - item.product.finalPrice).toFixed(2) %> per item</span>
                            <% } else { %>
                              <span class="current-price">₹<%= item.product.finalPrice.toFixed(2) %></span>
                            <% } %>
                          </div>
                        </div>

                        <!-- Line Total Display -->
                        <div class="line-total-section">
                          <span class="price-label">Line total (× <%= item.quantity %>):</span>
                          <div class="line-total">
                            <% if (item.product.discountPercentage > 0) { %>
                              <span class="line-original-total">₹<%= (item.quantity * item.product.regularPrice).toFixed(2) %></span>
                              <span class="line-discounted-total" data-item-total="<%= (item.quantity * item.product.finalPrice).toFixed(2) %>">₹<%= (item.quantity * item.product.finalPrice).toFixed(2) %></span>
                            <% } else { %>
                              <span class="line-current-total" data-item-total="<%= (item.quantity * item.product.finalPrice).toFixed(2) %>">₹<%= (item.quantity * item.product.finalPrice).toFixed(2) %></span>
                            <% } %>
                          </div>
                        </div>
                      </div>
                      <div class="item-actions">
                        <button class="btn-remove-item remove-item">
                          <i class="ri-delete-bin-line"></i>
                          Remove
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>

          <!-- Continue Shopping Link -->
          <div class="continue-shopping-section">
            <a href="/shopPage" class="continue-shopping-link">
              <i class="ri-arrow-left-line"></i>
              Continue Shopping
            </a>
          </div>
        </div>
      </div>

      <!-- Order Summary Column -->
      <div class="col-lg-4">
        <div class="order-summary-container" id="orderSummary">
          <div class="order-summary-card floating-card">
            <div class="summary-header">
              <h2 class="summary-title">Order Summary</h2>
              <div class="summary-icon">
                <i class="ri-file-list-3-line"></i>
              </div>
            </div>
            
            <div class="summary-content">
              <!-- Item Count -->
              <div class="summary-row items-count-row">
                <span class="summary-label">
                  <i class="ri-shopping-bag-line"></i>
                  Items in Cart
                </span>
                <span class="summary-value"><%= cartItems.reduce((sum, item) => sum + item.quantity, 0) %> items</span>
              </div>

              <!-- Original Subtotal -->
              <div class="summary-row">
                <span class="summary-label">Original Subtotal</span>
                <span class="summary-value">₹<%= (parseFloat(totalAmount) + parseFloat(totalDiscount)).toFixed(2) %></span>
              </div>
              
              <!-- Offer Breakdown -->
              <% if (offerBreakdown && offerBreakdown.length > 0) { %>
                <% offerBreakdown.forEach(offer => { %>
                  <div class="summary-row discount-row">
                    <span class="summary-label">
                      <i class="ri-price-tag-3-line"></i>
                      <%= offer.title %>
                      <% if (offer.isSpecialOffer) { %>
                        <span class="special-offer-badge">Auto</span>
                      <% } %>
                    </span>
                    <span class="summary-value discount-value">-₹<%= offer.discount.toFixed(2) %></span>
                  </div>
                <% }) %>
              <% } else if (totalDiscount > 0) { %>
                <div class="summary-row discount-row">
                  <span class="summary-label">
                    <i class="ri-price-tag-3-line"></i>
                    Total Savings
                  </span>
                  <span class="summary-value discount-value">-₹<%= totalDiscount %></span>
                </div>
              <% } %>

              <!-- Subtotal after discounts -->
              <% if (parseFloat(totalDiscount) > 0) { %>
                <div class="summary-row subtotal-after-discount">
                  <span class="summary-label">Subtotal after Discounts</span>
                  <span class="summary-value">₹<%= totalAmount %></span>
                </div>
              <% } %>
              
              <!-- Tax Information -->
              <div class="summary-row">
                <span class="summary-label">
                  <i class="ri-file-text-line"></i>
                  Tax (GST <%= gstPercentage %>)
                </span>
                <span class="summary-value">₹<%= gstAmount.toFixed(2) %></span>
              </div>

              <!-- Shipping -->
              <div class="summary-row">
                <span class="summary-label">
                  <i class="ri-truck-line"></i>
                  Shipping
                </span>
                <span class="summary-value free-shipping">FREE</span>
              </div>

              <div class="summary-divider"></div>

              <!-- Total -->
              <div class="summary-total">
                <div class="total-breakdown">
                  <span class="total-label">Total Amount (incl. GST)</span>
                  <% if (parseFloat(totalDiscount) > 0) { %>
                    <span class="total-savings">You save ₹<%= totalDiscount %></span>
                  <% } %>
                </div>
                <span class="total-value">₹<%= finalTotal.toFixed(2) %></span>
              </div>
              
              <!-- Checkout Button -->
              <a href="/checkout" class="btn-checkout">
                <i class="ri-secure-payment-line"></i>
                <span>Proceed to Checkout</span>
              </a>
              
              <!-- Security Info -->
              <div class="security-info">
                <div class="security-item">
                  <i class="ri-shield-check-line"></i>
                  <span>Secure checkout</span>
                </div>
                <div class="security-item">
                  <i class="ri-arrow-go-back-line"></i>
                  <span>Easy returns</span>
                </div>
              </div>
              
              <!-- Payment Methods -->
              <div class="payment-methods">
                <div class="payment-methods-title">We accept</div>
                <div class="payment-icons">
                  <div class="payment-icon"><i class="ri-visa-line"></i></div>
                  <div class="payment-icon"><i class="ri-mastercard-line"></i></div>
                  <div class="payment-icon"><i class="ri-paypal-line"></i></div>
                  <div class="payment-icon"><i class="ri-apple-pay-line"></i></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% } %>
  </div>
</section>

<!-- You May Also Like Section -->
<% if (relatedProducts && relatedProducts.length > 0) { %>
<section class="related-products-section">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title">You May Also Like</h2>
      <div class="title-underline"></div>
    </div>
    <div class="related-products-grid">
      <% relatedProducts.slice(0, 4).forEach(product => { %>
        <div class="related-product-card floating-card">
          <div class="related-product-image">
            <% if (product.activeOffer && product.discountPercentage > 0) { %>
              <span class="related-discount-badge">
                <%= Math.round(product.discountPercentage) %>% OFF
              </span>
            <% } %>
            <a href="/products/<%= product._id %>">
              <img src="<%= product.mainImage || '/api/placeholder/300/300' %>" alt="<%= product.model %>">
            </a>
            <div class="related-product-overlay">
              <button class="btn-quick-add add-to-cart" data-product-id="<%= product._id %>">
                <i class="ri-shopping-cart-line"></i>
              </button>
            </div>
          </div>
          <div class="related-product-info">
            <div class="related-brand"><%= product.brand %></div>
            <h4 class="related-title">
              <a href="/products/<%= product._id %>"><%= product.model %></a>
            </h4>
            <div class="related-rating">
              <div class="related-stars">
                <i class="ri-star-fill"></i>
                <i class="ri-star-fill"></i>
                <i class="ri-star-fill"></i>
                <i class="ri-star-fill"></i>
                <i class="ri-star-half-line"></i>
              </div>
              <span class="related-rating-text">(4.2)</span>
            </div>
            <div class="related-price">
              <% if (product.discountPercentage > 0) { %>
                <span class="related-original-price">₹<%= product.regularPrice.toFixed(2) %></span>
                <span class="related-current-price">₹<%= product.finalPrice.toFixed(2) %></span>
              <% } else { %>
                <span class="related-current-price">₹<%= product.regularPrice.toFixed(2) %></span>
              <% } %>
            </div>
            <div class="related-stock stock-<%= product.stock > 10 ? 'in-stock' : product.stock > 0 ? 'low-stock' : 'out-of-stock' %>">
              <i class="<%= product.stock > 10 ? 'ri-checkbox-circle-line' : product.stock > 0 ? 'ri-error-warning-line' : 'ri-close-circle-line' %>"></i>
              <%= product.stock > 10 ? 'In Stock' : product.stock > 0 ? 'Low Stock' : 'Out of Stock' %>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  </div>
</section>
<% } %>



<%- include("../partials/user/footer") %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Constants
  const GST_RATE = <%= gstRate %>;

  // DOM Elements
  const clearCartBtn = document.querySelector('#clearCartBtn');
  const emptyCart = document.querySelector('.empty-cart-container');
  const cartItemsContainer = document.querySelector('.cart-items-container');
  const orderSummary = document.querySelector('#orderSummary');
  const cartCountElement = document.querySelector('.cart-count');
  
  // Store initial values for all quantity inputs
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.dataset.previousValue = input.value;
  });

  // Clear cart
  if (clearCartBtn) {
    clearCartBtn.addEventListener('click', clearCart);
  }

  // Set up event listeners for all cart items
  setupCartItemHandlers();

  // Add to cart for related products
  document.querySelectorAll('.add-to-cart').forEach(button => {
    button.addEventListener('click', function() {
      addToCart(this.dataset.productId);
    });
  });

  // Fixed order summary on scroll
  window.addEventListener('scroll', handleOrderSummaryPosition);

  // Main Functions
  async function clearCart() {
    const result = await Swal.fire({
      title: 'Clear Cart?',
      text: 'Are you sure you want to remove all items from your cart? This action cannot be undone.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#1B3C53',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Yes, clear it!',
      cancelButtonText: 'Cancel',
      reverseButtons: true
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch('/api/cart/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin'
        });

        if (!response.ok) {
          throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
        }

        const apiResult = await response.json();

        if (apiResult.success) {
          window.location.reload();
        } else {
          showNotification('error', apiResult.message || 'Failed to clear cart');
        }
      } catch (error) {
        console.error('Clear cart error:', error);
        showNotification('error', 'Error clearing cart');
      }
    }
  }

  function setupCartItemHandlers() {
    const cartItems = document.querySelectorAll('.cart-item');
    
    cartItems.forEach(item => {
      const productId = item.dataset.productId;
      const minusBtn = item.querySelector('.quantity-minus');
      const plusBtn = item.querySelector('.quantity-plus');
      const quantityInput = item.querySelector('.quantity-input');
      const removeBtn = item.querySelector('.remove-item');

      if (!quantityInput) return;

      quantityInput.dataset.previousValue = quantityInput.value;
      let updateTimeout;

      minusBtn && minusBtn.addEventListener('click', function() {
        let value = parseInt(quantityInput.value);
        if (value > 1) {
          quantityInput.value = value - 1;
          clearTimeout(updateTimeout);
          updateTimeout = setTimeout(() => {
            updateCartItem(productId, parseInt(quantityInput.value), item);
          }, 300);
        }
      });

      plusBtn && plusBtn.addEventListener('click', function() {
        let value = parseInt(quantityInput.value);
        const maxValue = parseInt(quantityInput.getAttribute('max') || '999');
        
        if (value >= maxValue) {
          const isQuantityLimit = maxValue === 5;
          const message = isQuantityLimit
            ? `Maximum 5 items allowed per product`
            : `Only ${maxValue} items in stock`;
          showNotification('error', message);
          return;
        }

        quantityInput.value = value + 1;
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
          updateCartItem(productId, parseInt(quantityInput.value), item);
        }, 300);
      });

      quantityInput && quantityInput.addEventListener('change', function() {
        let value = parseInt(this.value);
        const maxValue = parseInt(this.getAttribute('max') || '999');
        
        if (isNaN(value) || value < 1) {
          value = 1;
        } else if (value > maxValue) {
          value = maxValue;
          this.value = value;
          showNotification('error', `Only ${maxValue} items in stock`);
          return;
        }
        
        this.value = value;
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
          updateCartItem(productId, value, item);
        }, 300);
      });

      removeBtn && removeBtn.addEventListener('click', function() {
        removeCartItem(productId, item);
      });
    });
  }

  async function updateCartItem(productId, quantity, item) {
    try {
      item.classList.add('updating');
      
      const quantityInput = item.querySelector('.quantity-input');
      const previousValue = quantityInput.dataset.previousValue;
      
      const response = await fetch('/api/cart/update', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
          productId: productId,
          quantity: quantity
        })
      });
      
      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();

      if (result.success) {
        quantityInput.dataset.previousValue = quantity;

        // Update line totals
        updateItemPricing(item, quantity, result);

        // Update order summary
        if (typeof result.totalAmount === 'number') {
          updateOrderSummaryPricing(result.totalAmount, result.cartCount);
        }

        if (result.cartCount !== undefined) {
          updateCartCount(result.cartCount);
        } else {
          recalculateCartCount();
        }

        showNotification('success', result.message || 'Cart updated successfully');
      } else {
        quantityInput.value = previousValue;
        showNotification('error', result.message || 'Failed to update cart');
      }
    } catch (error) {
      console.error('Error updating cart:', error);
      const quantityInput = item.querySelector('.quantity-input');
      const previousValue = quantityInput.dataset.previousValue;
      quantityInput.value = previousValue;
      showNotification('error', 'Failed to update cart. Please try again.');
    } finally {
      // Remove loading state
      item.classList.remove('updating');
    }
  }

  async function removeCartItem(productId, item) {
    try {
      // Store scroll position
      const scrollPosition = window.pageYOffset;

      // Add loading state
      item.style.opacity = '0.5';
      item.style.pointerEvents = 'none';

      // Add loading spinner to the item
      const loadingSpinner = document.createElement('div');
      loadingSpinner.className = 'loading-overlay';
      loadingSpinner.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Removing...</span></div>';
      loadingSpinner.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
        background: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 5px;
      `;
      item.style.position = 'relative';
      item.appendChild(loadingSpinner);

      const response = await fetch('/api/cart/remove', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ productId })
      });

      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }

      const result = await response.json();

      if (result.success) {
        // Remove loading spinner
        loadingSpinner.remove();

        // Animate item removal
        item.style.transition = 'all 0.3s ease-out';
        item.style.opacity = '0';
        item.style.transform = 'translateX(-100%)';
        item.style.height = '0';
        item.style.marginBottom = '0';
        item.style.paddingTop = '0';
        item.style.paddingBottom = '0';

        // Update cart count and totals without page reload
        updateCartCount(result.cartCount);
        updateCartTotals(result.totalAmount);

        // Remove item from DOM after animation
        setTimeout(() => {
          item.remove();

          // Check if cart is empty and show empty state
          const remainingItems = document.querySelectorAll('.cart-item');
          if (remainingItems.length === 0) {
            showEmptyCartState();
          }

          // Restore scroll position
          window.scrollTo(0, scrollPosition);
        }, 300);

        showNotification('success', 'Item removed from cart');
      } else {
        // Remove loading spinner and restore item state
        loadingSpinner.remove();
        item.style.opacity = '1';
        item.style.pointerEvents = 'auto';
        showNotification('error', result.message || 'Failed to remove item');
      }
    } catch (error) {
      console.error('Remove item error:', error);

      // Remove loading spinner if it exists
      const loadingSpinner = item.querySelector('.loading-overlay');
      if (loadingSpinner) {
        loadingSpinner.remove();
      }

      // Restore item state
      item.style.opacity = '1';
      item.style.pointerEvents = 'auto';
      showNotification('error', 'Error removing item from cart');
    }
  }

  async function addToCart(productId) {
    try {
      const response = await fetch('/api/cart/add', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ productId, quantity: 1 })
      });
      
      if (!response.ok) {
        throw new Error(`Server responded with ${response.status}: ${response.statusText}`);
      }
      
      const result = await response.json();

      if (result.success) {
        updateCartCount(result.cartCount);
        showNotification('success', result.message || 'Item added to cart');
      } else {
        showNotification('error', result.message || 'Failed to add item to cart');
      }
    } catch (error) {
      console.error('Add to cart error:', error);
      showNotification('error', 'Error adding to cart');
    }
  }

  // Helper Functions
  function updateCartCount(count) {
    if (cartCountElement) {
      cartCountElement.textContent = count;
      cartCountElement.dataset.count = count;
    }

    // Also update other cart count elements
    const cartCountElements = document.querySelectorAll('.cart-count, .cart-badge');
    cartCountElements.forEach(element => {
      element.textContent = count;
      if (count === 0) {
        element.style.display = 'none';
      } else {
        element.style.display = 'inline-block';
      }
    });
  }

  function updateCartTotals(totalAmount) {
    // Update subtotal
    const subtotalElements = document.querySelectorAll('.subtotal-amount, .cart-subtotal');
    subtotalElements.forEach(element => {
      element.textContent = `₹${totalAmount.toLocaleString('en-IN')}`;
    });

    // Update total (including GST if applicable)
    const gstRate = 0.18; // 18% GST
    const gstAmount = totalAmount * gstRate;
    const finalTotal = totalAmount + gstAmount;

    const totalElements = document.querySelectorAll('.total-amount, .cart-total');
    totalElements.forEach(element => {
      element.textContent = `₹${finalTotal.toLocaleString('en-IN')}`;
    });

    // Update GST amount if element exists
    const gstElements = document.querySelectorAll('.gst-amount');
    gstElements.forEach(element => {
      element.textContent = `₹${gstAmount.toLocaleString('en-IN')}`;
    });
  }

  function showEmptyCartState() {
    const cartContainer = document.querySelector('.cart-items-container, .cart-content');
    if (cartContainer) {
      cartContainer.innerHTML = `
        <div class="empty-cart-state text-center py-5">
          <div class="empty-cart-icon mb-3">
            <i class="ri-shopping-cart-line" style="font-size: 4rem; color: #ccc;"></i>
          </div>
          <h3 class="mb-3">Your cart is empty</h3>
          <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet.</p>
          <a href="/products" class="btn btn-primary">
            <i class="ri-shopping-bag-line me-2"></i>Continue Shopping
          </a>
        </div>
      `;
    }

    // Hide order summary
    const orderSummary = document.querySelector('.order-summary, .cart-summary');
    if (orderSummary) {
      orderSummary.style.display = 'none';
    }
  }

  function recalculateCartCount() {
    if (cartCountElement) {
      const count = Array.from(document.querySelectorAll('.cart-item'))
        .reduce((sum, item) => {
          const input = item.querySelector('.quantity-input');
          return sum + (input ? parseInt(input.value) : 0);
        }, 0);
      
      cartCountElement.textContent = count;
      cartCountElement.dataset.count = count;
    }
  }

  function updateItemPricing(item, quantity, result) {
    // Update line totals
    const lineTotalElement = item.querySelector('.line-discounted-total') || item.querySelector('.line-current-total');
    if (lineTotalElement) {
      lineTotalElement.textContent = `₹${result.itemTotal.toFixed(2)}`;
      lineTotalElement.setAttribute('data-item-total', result.itemTotal.toFixed(2));

      // Add visual feedback
      lineTotalElement.classList.add('updated');
      setTimeout(() => {
        lineTotalElement.classList.remove('updated');
      }, 1000);
    }

    // Update line total label to show current quantity
    const lineTotalLabel = item.querySelector('.line-total-section .price-label');
    if (lineTotalLabel) {
      lineTotalLabel.textContent = `Line total (× ${quantity}):`;
    }

    // Update line original total if it exists (for discounted items)
    const lineOriginalTotal = item.querySelector('.line-original-total');
    if (lineOriginalTotal) {
      const originalPriceElement = item.querySelector('.original-price');
      if (originalPriceElement) {
        const originalPrice = parseFloat(originalPriceElement.textContent.replace('₹', ''));
        lineOriginalTotal.textContent = `₹${(quantity * originalPrice).toFixed(2)}`;
      }
    }

    // Update quantity display
    const quantityInput = item.querySelector('.quantity-input');
    if (quantityInput) {
      quantityInput.value = quantity;
    }
  }

  function updateOrderSummaryPricing(totalAmount, cartCount) {
    // Calculate totals from all items
    const allItems = document.querySelectorAll('.cart-item');
    let originalSubtotal = 0;
    let currentSubtotal = 0;
    let totalItems = 0;

    allItems.forEach(item => {
      const quantityInput = item.querySelector('.quantity-input');
      const quantity = quantityInput ? parseInt(quantityInput.value) : 0;
      totalItems += quantity;

      // Get original and current prices
      const originalPriceElement = item.querySelector('.original-price');
      const currentPriceElement = item.querySelector('.discounted-price') || item.querySelector('.current-price');
      const lineTotalElement = item.querySelector('.line-discounted-total') || item.querySelector('.line-current-total');

      if (originalPriceElement && currentPriceElement) {
        const originalPrice = parseFloat(originalPriceElement.textContent.replace('₹', ''));
        originalSubtotal += originalPrice * quantity;
      }

      if (lineTotalElement) {
        const lineTotal = parseFloat(lineTotalElement.getAttribute('data-item-total') || lineTotalElement.textContent.replace('₹', ''));
        currentSubtotal += lineTotal;
      }
    });

    const totalSavings = originalSubtotal - currentSubtotal;

    // Update summary elements
    const itemsCountElement = document.querySelector('.items-count-row .summary-value');
    if (itemsCountElement) {
      itemsCountElement.textContent = `${totalItems} items`;
    }

    const originalSubtotalElement = document.querySelector('.summary-row:not(.discount-row):not(.items-count-row) .summary-value');
    if (originalSubtotalElement && totalSavings > 0) {
      originalSubtotalElement.textContent = `₹${originalSubtotal.toFixed(2)}`;
    }

    const discountElement = document.querySelector('.discount-row .discount-value');
    if (discountElement && totalSavings > 0) {
      discountElement.textContent = `-₹${totalSavings.toFixed(2)}`;
    }

    const subtotalAfterDiscountElement = document.querySelector('.subtotal-after-discount .summary-value');
    if (subtotalAfterDiscountElement && totalSavings > 0) {
      subtotalAfterDiscountElement.textContent = `₹${currentSubtotal.toFixed(2)}`;
    }

    // Calculate GST and final total
    const gstAmount = Math.round(currentSubtotal * GST_RATE * 100) / 100;
    const finalTotal = currentSubtotal + gstAmount;

    // Update GST display
    const gstElements = document.querySelectorAll('.summary-row .summary-label');
    for (const label of gstElements) {
      if (label.textContent.includes('Tax')) {
        const gstElement = label.parentElement.querySelector('.summary-value');
        if (gstElement) {
          gstElement.textContent = `₹${gstAmount.toFixed(2)}`;
        }
        break;
      }
    }

    const totalValueElement = document.querySelector('.total-value');
    if (totalValueElement) {
      totalValueElement.textContent = `₹${finalTotal.toFixed(2)}`;

      // Add visual feedback
      totalValueElement.classList.add('updated');
      setTimeout(() => {
        totalValueElement.classList.remove('updated');
      }, 1000);
    }

    const totalSavingsElement = document.querySelector('.total-savings');
    if (totalSavingsElement && totalSavings > 0) {
      totalSavingsElement.textContent = `You save ₹${totalSavings.toFixed(2)}`;
    }
  }

  function handleOrderSummaryPosition() {
    if (!orderSummary) return;
    
    const parentContainer = orderSummary.closest('.col-lg-4');
    if (!parentContainer) return;
    
    const parentRect = parentContainer.getBoundingClientRect();
    const summaryHeight = orderSummary.offsetHeight;
    const windowHeight = window.innerHeight;
    
    if (window.innerWidth >= 992) {
      if (parentRect.top < 80 && parentRect.bottom > (summaryHeight + 80)) {
        orderSummary.classList.add('sticky-summary');
        orderSummary.style.width = parentRect.width + 'px';
        orderSummary.style.maxHeight = (windowHeight - 100) + 'px';
      } else {
        orderSummary.classList.remove('sticky-summary');
        orderSummary.style.width = '';
        orderSummary.style.maxHeight = '';
      }
    } else {
      orderSummary.classList.remove('sticky-summary');
      orderSummary.style.width = '';
      orderSummary.style.maxHeight = '';
    }
  }

  function showNotification(type, message) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: type,
      title: message,
      showConfirmButton: false,
      timer: 3000
    });
  }






});
</script>