<%- include('../partials/admin/sidebar') %>

  <!-- Main Content -->
  <div class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="text-muted mb-0">Welcome back, Admin! Here's what's happening with your Phoenix audio store today.</p>
      </div>
      <div class="page-actions">
        <a href="/admin/add-product" class="btn btn-primary">
          <i class="ri-add-line"></i> Add Product
        </a>
        <a href="/admin/getOrders" class="btn btn-outline-primary">
          <i class="ri-list-check"></i> View Orders
        </a>
      </div>
    </div>

    <!-- Enhanced Stats Row -->
    <div class="row g-4 mb-4">
      <!-- Users Stats -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon users">
            <i class="ri-user-line"></i>
          </div>
          <h2 class="stat-title">Total Users</h2>
          <p class="stat-value"><%= dashboardStats.totalUsers.value %></p>
          <small class="stat-subtitle">+<%= dashboardStats.totalUsers.newToday %> today</small>
        </div>
      </div>

      <!-- Orders Stats -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon orders">
            <i class="ri-shopping-bag-line"></i>
          </div>
          <h2 class="stat-title">Total Orders</h2>
          <p class="stat-value"><%= dashboardStats.totalOrders.value %></p>
          <small class="stat-subtitle">+<%= dashboardStats.totalOrders.today %> today</small>
        </div>
      </div>

      <!-- Sales Stats -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon sales">
            <i class="ri-currency-line"></i>
          </div>
          <h2 class="stat-title">Total Sales</h2>
          <p class="stat-value"><%= dashboardStats.totalSales.value %></p>
          <small class="stat-subtitle"><%= dashboardStats.totalSales.today %> today</small>
        </div>
      </div>

      <!-- Pending Stats -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon pending">
            <i class="ri-time-line"></i>
          </div>
          <h2 class="stat-title">Pending Orders</h2>
          <p class="stat-value"><%= dashboardStats.pendingOrders.value %></p>
          <small class="stat-subtitle">Need attention</small>
        </div>
      </div>
    </div>

    <!-- Additional Stats Row -->
    <div class="row g-4 mb-4">
      <!-- Return Requests -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon returns">
            <i class="ri-arrow-go-back-line"></i>
          </div>
          <h2 class="stat-title">Return Requests</h2>
          <p class="stat-value"><%= dashboardStats.returnRequests.value %></p>
          <small class="stat-subtitle">Pending review</small>
        </div>
      </div>

      <!-- Cancelled Orders -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon cancelled">
            <i class="ri-close-circle-line"></i>
          </div>
          <h2 class="stat-title">Cancelled Orders</h2>
          <p class="stat-value"><%= dashboardStats.cancelledOrders.value %></p>
          <small class="stat-subtitle">This month</small>
        </div>
      </div>

      <!-- Average Order Value -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon avg-order">
            <i class="ri-calculator-line"></i>
          </div>
          <h2 class="stat-title">Avg Order Value</h2>
          <p class="stat-value"><%= financialAnalytics.avgOrderValue %></p>
          <small class="stat-subtitle">Per order</small>
        </div>
      </div>

      <!-- Active Users -->
      <div class="col-sm-6 col-lg-3">
        <div class="stat-card">
          <div class="icon active-users">
            <i class="ri-user-star-line"></i>
          </div>
          <h2 class="stat-title">Active Users</h2>
          <p class="stat-value"><%= userAnalytics.activeUsersCount %></p>
          <small class="stat-subtitle">Last 30 days</small>
        </div>
      </div>
    </div>

    <!-- System Notifications -->
    <% if (systemNotifications && systemNotifications.length > 0) { %>
    <div class="row mb-4">
      <div class="col-12">
        <div class="notification-panel">
          <h3 class="section-title">
            <i class="ri-notification-line"></i>
            System Notifications
          </h3>
          <div class="notifications-list">
            <% systemNotifications.forEach(notification => { %>
            <div class="notification-item notification-<%= notification.type %> priority-<%= notification.priority %>">
              <div class="notification-content">
                <h4 class="notification-title"><%= notification.title %></h4>
                <p class="notification-message"><%= notification.message %></p>
              </div>
              <div class="notification-action">
                <a href="<%= notification.action %>" class="btn btn-sm btn-<%= notification.type %>">
                  <%= notification.actionText %>
                </a>
              </div>
            </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>
    <% } %>

    <!-- Charts and Analytics Row -->
    <div class="row g-4 mb-4">
      <!-- Sales Trend Chart -->
      <div class="col-lg-8">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Sales Trend (Last 7 Days)</h3>
            <select class="chart-filter" id="salesPeriod">
              <option value="7">Last 7 Days</option>
              <option value="30">Last 30 Days</option>
              <option value="90">Last 3 Months</option>
            </select>
          </div>
          <div class="chart-container">
            <canvas id="salesChart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Order Status Distribution -->
      <div class="col-lg-4">
        <div class="chart-card">
          <div class="chart-header">
            <h3 class="chart-title">Order Status Distribution</h3>
          </div>
          <div class="chart-container">
            <canvas id="orderStatusChart" width="300" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Financial Analytics Row -->
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="analytics-card">
          <h3 class="section-title">
            <i class="ri-money-dollar-circle-line"></i>
            Financial Overview
          </h3>
          <div class="financial-stats">
            <div class="financial-item">
              <span class="financial-label">Today's Revenue</span>
              <span class="financial-value text-success"><%= financialAnalytics.revenueToday %></span>
            </div>
            <div class="financial-item">
              <span class="financial-label">This Week</span>
              <span class="financial-value"><%= financialAnalytics.revenueThisWeek %></span>
            </div>
            <div class="financial-item">
              <span class="financial-label">This Month</span>
              <span class="financial-value"><%= financialAnalytics.revenueThisMonth %></span>
            </div>
            <div class="financial-item">
              <span class="financial-label">This Year</span>
              <span class="financial-value text-primary"><%= financialAnalytics.revenueThisYear %></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Methods -->
      <div class="col-lg-6">
        <div class="analytics-card">
          <h3 class="section-title">
            <i class="ri-bank-card-line"></i>
            Payment Methods
          </h3>
          <div class="payment-methods">
            <% if (orderAnalytics.paymentBreakdown.COD) { %>
            <div class="payment-item">
              <div class="payment-info">
                <span class="payment-method">Cash on Delivery</span>
                <span class="payment-count"><%= orderAnalytics.paymentBreakdown.COD.count %> orders</span>
              </div>
              <span class="payment-total"><%= orderAnalytics.paymentBreakdown.COD.total %></span>
            </div>
            <% } %>
            <% Object.keys(orderAnalytics.paymentBreakdown).forEach(method => { %>
              <% if (method !== 'COD' && method !== 'cod') { %>
              <div class="payment-item">
                <div class="payment-info">
                  <span class="payment-method"><%= method %></span>
                  <span class="payment-count"><%= orderAnalytics.paymentBreakdown[method].count %> orders</span>
                </div>
                <span class="payment-total"><%= orderAnalytics.paymentBreakdown[method].total %></span>
              </div>
              <% } %>
            <% }); %>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Management Section -->
    <div class="row g-4 mb-4">
      <div class="col-lg-8">
        <div class="management-card">
          <div class="card-header">
            <h3 class="section-title">
              <i class="ri-shopping-bag-line"></i>
              Recent Orders
            </h3>
            <a href="/admin/getOrders" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Order #</th>
                  <th>Customer</th>
                  <th>Items</th>
                  <th>Total</th>
                  <th>Status</th>
                  <th>Payment</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <% if (recentOrders && recentOrders.length > 0) { %>
                  <% recentOrders.slice(0, 8).forEach(order => { %>
                  <tr>
                    <td><strong><%= order.orderNumber %></strong></td>
                    <td>
                      <div class="customer-info">
                        <span class="customer-name"><%= order.customerName %></span>
                        <small class="customer-email"><%= order.customerEmail %></small>
                      </div>
                    </td>
                    <td><%= order.itemCount %> items</td>
                    <td><strong><%= order.total %></strong></td>
                    <td>
                      <span class="status-badge status-<%= order.status.toLowerCase().replace(/\s+/g, '-') %>">
                        <%= order.status %>
                      </span>
                    </td>
                    <td><%= order.paymentMethod %></td>
                    <td><%= order.formattedDate %></td>
                  </tr>
                  <% }); %>
                <% } else { %>
                  <tr>
                    <td colspan="7" class="text-center text-muted">No recent orders found</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Order Analytics -->
      <div class="col-lg-4">
        <div class="analytics-card">
          <h3 class="section-title">
            <i class="ri-bar-chart-line"></i>
            Order Analytics
          </h3>
          <div class="order-stats">
            <% Object.keys(orderAnalytics.statusBreakdown).forEach(status => { %>
            <div class="order-stat-item">
              <span class="stat-label"><%= status %></span>
              <span class="stat-value"><%= orderAnalytics.statusBreakdown[status] %></span>
            </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Management Section -->
    <div class="row g-4 mb-4">
      <!-- Low Stock Alerts -->
      <div class="col-lg-6">
        <div class="management-card">
          <div class="card-header">
            <h3 class="section-title">
              <i class="ri-error-warning-line"></i>
              Low Stock Alerts
            </h3>
            <a href="/admin/getProducts" class="btn btn-sm btn-outline-warning">Manage Stock</a>
          </div>
          <div class="low-stock-list">
            <% if (productAnalytics.lowStockProducts && productAnalytics.lowStockProducts.length > 0) { %>
              <% productAnalytics.lowStockProducts.slice(0, 5).forEach(product => { %>
              <div class="product-item low-stock">
                <img src="<%= product.image %>" alt="<%= product.title %>" class="product-image">
                <div class="product-info">
                  <h4 class="product-title"><%= product.title %></h4>
                  <p class="product-category"><%= product.category %></p>
                  <span class="stock-status <%= product.stock === 0 ? 'out-of-stock' : 'low-stock' %>">
                    <%= product.stockStatus %> (<%= product.stock %> left)
                  </span>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="empty-state">
                <i class="ri-check-line"></i>
                <p>All products are well stocked!</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Top Selling Products -->
      <div class="col-lg-6">
        <div class="management-card">
          <div class="card-header">
            <h3 class="section-title">
              <i class="ri-trophy-line"></i>
              Top Selling Audio Equipment
            </h3>
            <a href="/admin/getProducts" class="btn btn-sm btn-outline-success">View All</a>
          </div>
          <div class="top-products-list">
            <% if (productAnalytics.topProducts && productAnalytics.topProducts.length > 0) { %>
              <% productAnalytics.topProducts.forEach((product, index) => { %>
              <div class="product-item top-product">
                <div class="product-rank">#<%= index + 1 %></div>
                <img src="<%= product.image %>" alt="<%= product.title %>" class="product-image">
                <div class="product-info">
                  <h4 class="product-title"><%= product.title %></h4>
                  <div class="product-stats">
                    <span class="sold-count"><%= product.totalSold %> sold</span>
                    <span class="revenue"><%= product.revenue %> revenue</span>
                  </div>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="empty-state">
                <i class="ri-headphone-line"></i>
                <p>No sales data available yet</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- User Management Section -->
    <div class="row g-4 mb-4">
      <div class="col-lg-6">
        <div class="management-card">
          <div class="card-header">
            <h3 class="section-title">
              <i class="ri-user-add-line"></i>
              Recent User Registrations
            </h3>
            <a href="/admin/getUsers" class="btn btn-sm btn-outline-primary">Manage Users</a>
          </div>
          <div class="user-list">
            <% if (userAnalytics.recentUsers && userAnalytics.recentUsers.length > 0) { %>
              <% userAnalytics.recentUsers.forEach(user => { %>
              <div class="user-item">
                <div class="user-avatar">
                  <i class="ri-user-line"></i>
                </div>
                <div class="user-info">
                  <h4 class="user-name"><%= user.name %></h4>
                  <p class="user-email"><%= user.email %></p>
                  <small class="user-date">Joined <%= user.joinDate %></small>
                </div>
                <div class="user-status">
                  <span class="status-badge <%= user.isVerified ? 'verified' : 'unverified' %>">
                    <%= user.isVerified ? 'Verified' : 'Unverified' %>
                  </span>
                </div>
              </div>
              <% }); %>
            <% } else { %>
              <div class="empty-state">
                <i class="ri-user-line"></i>
                <p>No recent registrations</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>

      <!-- User Analytics -->
      <div class="col-lg-6">
        <div class="analytics-card">
          <h3 class="section-title">
            <i class="ri-group-line"></i>
            User Analytics
          </h3>
          <div class="user-analytics">
            <div class="analytics-item">
              <div class="analytics-icon">
                <i class="ri-calendar-line"></i>
              </div>
              <div class="analytics-content">
                <span class="analytics-label">New Users Today</span>
                <span class="analytics-value"><%= userAnalytics.newUsersToday %></span>
              </div>
            </div>
            <div class="analytics-item">
              <div class="analytics-icon">
                <i class="ri-calendar-week-line"></i>
              </div>
              <div class="analytics-content">
                <span class="analytics-label">This Week</span>
                <span class="analytics-value"><%= userAnalytics.newUsersThisWeek %></span>
              </div>
            </div>
            <div class="analytics-item">
              <div class="analytics-icon">
                <i class="ri-calendar-month-line"></i>
              </div>
              <div class="analytics-content">
                <span class="analytics-label">This Month</span>
                <span class="analytics-value"><%= userAnalytics.newUsersThisMonth %></span>
              </div>
            </div>
            <div class="analytics-item">
              <div class="analytics-icon">
                <i class="ri-user-star-line"></i>
              </div>
              <div class="analytics-content">
                <span class="analytics-label">Active Users</span>
                <span class="analytics-value"><%= userAnalytics.activeUsersCount %></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mb-4">
      <div class="col-12">
        <div class="quick-actions-card">
          <h3 class="section-title">
            <i class="ri-flashlight-line"></i>
            Quick Actions
          </h3>
          <div class="quick-actions-grid">
            <a href="/admin/add-product" class="quick-action-item">
              <div class="action-icon">
                <i class="ri-add-box-line"></i>
              </div>
              <span class="action-label">Add New Product</span>
            </a>
            <a href="/admin/getOrders?status=Placed" class="quick-action-item">
              <div class="action-icon">
                <i class="ri-shopping-bag-line"></i>
              </div>
              <span class="action-label">Process Orders</span>
            </a>
            <a href="/admin/categories" class="quick-action-item">
              <div class="action-icon">
                <i class="ri-folder-line"></i>
              </div>
              <span class="action-label">Manage Categories</span>
            </a>
            <a href="/admin/return-management" class="quick-action-item">
              <div class="action-icon">
                <i class="ri-arrow-go-back-line"></i>
              </div>
              <span class="action-label">Handle Returns</span>
            </a>
            <a href="/admin/getProducts?filter=low-stock" class="quick-action-item">
              <div class="action-icon">
                <i class="ri-error-warning-line"></i>
              </div>
              <span class="action-label">Check Inventory</span>
            </a>
            <a href="/admin/getUsers" class="quick-action-item">
              <div class="action-icon">
                <i class="ri-user-settings-line"></i>
              </div>
              <span class="action-label">Manage Users</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Chart data from server
    const chartData = <%- JSON.stringify(chartData) %>;

    // Sales Trend Chart
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    const salesChart = new Chart(salesCtx, {
      type: 'line',
      data: {
        labels: chartData.salesTrend.map(item => {
          const date = new Date(item.date);
          return date.toLocaleDateString('en-IN', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
          label: 'Revenue (₹)',
          data: chartData.salesTrend.map(item => item.revenue),
          borderColor: '#FF0000',
          backgroundColor: 'rgba(255, 0, 0, 0.1)',
          borderWidth: 2,
          fill: true,
          tension: 0.4
        }, {
          label: 'Orders',
          data: chartData.salesTrend.map(item => item.orders),
          borderColor: '#000000',
          backgroundColor: 'rgba(0, 0, 0, 0.1)',
          borderWidth: 2,
          fill: false,
          tension: 0.4,
          yAxisID: 'y1'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: false
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Revenue (₹)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Orders'
            },
            grid: {
              drawOnChartArea: false,
            },
          }
        }
      }
    });

    // Order Status Chart
    const orderStatusCtx = document.getElementById('orderStatusChart').getContext('2d');
    const orderStatusChart = new Chart(orderStatusCtx, {
      type: 'doughnut',
      data: {
        labels: chartData.orderStatus.map(item => item.label),
        datasets: [{
          data: chartData.orderStatus.map(item => item.value),
          backgroundColor: [
            '#28a745', // Delivered - Green
            '#007bff', // Shipped - Blue
            '#ffc107', // Processing - Yellow
            '#6c757d', // Placed - Gray
            '#dc3545', // Cancelled - Red
            '#fd7e14', // Return Requested - Orange
            '#20c997'  // Returned - Teal
          ],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          }
        }
      }
    });

    // Highlight active navigation link
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
      link.addEventListener('click', function() {
        navLinks.forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    });

    // Auto-refresh dashboard data every 5 minutes
    setInterval(() => {
      location.reload();
    }, 300000);

    // Notification auto-hide
    setTimeout(() => {
      const notifications = document.querySelectorAll('.notification-item');
      notifications.forEach(notification => {
        if (notification.classList.contains('priority-low')) {
          notification.style.opacity = '0.7';
        }
      });
    }, 10000);
  </script>
</body>
</html>